with
acc_metr AS(
  SELECT
    s.date AS date,
    sp.country AS country,
    a.send_interval AS send_interval,
    a.is_verified AS is_verified,
    a.is_unsubscribed AS is_unsubscribed,
    COUNT(DISTINCT a.id) as account_cnt
    FROM
    `DA.account` a
  JOIN
    `DA.account_session` acs
  ON
    a.id = acs.account_id
  JOIN
    `DA.session` s
  ON
    acs.ga_session_id = s.ga_session_id
  JOIN
    `DA.session_params` sp
  ON
    acs.ga_session_id = sp.ga_session_id
  GROUP BY
    s.date,
    sp.country,
    send_interval,
    a.is_verified,
    a.is_unsubscribed),

    em_metr as (
      select date_add(s.date, INTERVAL es.sent_date day) as sent_date,
      sp.country as country,
      a.send_interval as send_interval,
      a.is_verified as is_verified,
      a.is_unsubscribed as is_unsubscribed,
      0 as account_cnt,
      count(distinct es.id_message) as sent_msg,
      count(distinct eo.id_message) as open_msg,
      count(distinct ev.id_message) as visit_msg
   FROM
    `DA.email_sent` es
  LEFT JOIN
    `DA.email_open` eo
  ON
    es.id_message = eo.id_message
  LEFT JOIN
    `DA.email_visit` ev
  ON
    es.id_message = ev.id_message
  JOIN
    `DA.account` a
  ON
    es.id_account = a.id
  JOIN
    `DA.account_session` acs
  ON
    a.id = acs.account_id
  JOIN
    `DA.session` s
  ON
    acs.ga_session_id = s.ga_session_id
  JOIN
    `DA.session_params` sp
  ON
    acs.ga_session_id = sp.ga_session_id
    group by
    sent_date,
    country,
    send_interval,
    is_verified,
    is_unsubscribed
),

data_all as (
  select date,
  country,
   send_interval,
  is_verified,
  is_unsubscribed,
  0 as sent_msg,
  0 as open_msg,
  0 as visit_msg,
  account_cnt
 from acc_metr
  union all
  select  sent_date,
     country,
      send_interval,
       is_verified,
      is_unsubscribed,
      sent_msg,
      open_msg,
       visit_msg,
      0 as account_cnt
  from em_metr
),

data_total AS (
  SELECT
    date,
    country,
    send_interval,
    is_verified,
    is_unsubscribed,
    SUM(account_cnt) AS account_cnt,
    SUM(sent_msg) AS sent_msg,
    SUM(open_msg) AS open_msg,
    SUM(visit_msg) AS visit_msg
  FROM
    data_all
  GROUP BY
    date,
    country,
    send_interval,
    is_verified,
    is_unsubscribed ),

    data_country as (
      select * , sum(account_cnt) over (partition by country) as total_account_by_country,
      sum(sent_msg) over (partition by country) as total_account_sent_msg
      from data_total),

      data_send_interval as (
 select *, dense_rank() over (order by total_account_by_country desc) as rank_total_account_by_country,
 dense_rank() over (order by total_account_sent_msg desc) as rank_total_account_sent_msg
 from data_country)
 select * from data_send_interval
 where rank_total_account_by_country <= 10
 or rank_total_account_sent_msg <= 10
